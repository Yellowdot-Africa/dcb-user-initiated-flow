name: Deploy dcb_user_initiated_flow

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v2

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ”¨ Build the project
        run: npm run build

      - name: ğŸ§¾ Check Build Output
        run: ls -lah ./dist

      - name: ğŸ” Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY_YD_TELECEL }}" | tr -d '\r' > ~/.ssh/yd_telecel_key
          chmod 600 ~/.ssh/yd_telecel_key
          ssh-keyscan -p 22 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Securely Copy Files to Server
        run: |
          ssh -i ~/.ssh/yd_telecel_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "mkdir -p /var/www/dcb_user_initiated_flow/dist && chown -R ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} /var/www/dcb_user_initiated_flow/dist"
          rsync -e "ssh -i ~/.ssh/yd_telecel_key -o StrictHostKeyChecking=no" -avz --delete ./dist/ \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/dcb_user_initiated_flow/dist

      - name: ğŸš€ Deploy dcb_user_initiated_flow on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_KEY_YD_TELECEL }}
          port: 22
          script: |
            echo "ğŸ” Checking deployed files for dcb_user_initiated_flow..."
            ls -lah /var/www/dcb_user_initiated_flow/dist
            echo "ğŸ›  Setting permissions..."
            chown -R $USER:$USER /var/www/dcb_user_initiated_flow || echo "No permission to chown"
            chmod -R 755 /var/www/dcb_user_initiated_flow || echo "No permission to chmod"
            echo "ğŸ”„ Restarting Nginx..."
            systemctl restart nginx || echo "Could not restart nginx"
            echo "ğŸ“œ Nginx Error Log:"
            tail -n 20 /var/log/nginx/error.log || echo "Could not read nginx logs"
            echo "âœ… dcb_user_initiated_flow Deployment Completed!"
